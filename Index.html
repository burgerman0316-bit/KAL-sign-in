<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaneland Secure Site Login</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Identity Services SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Set the Inter font as default */
        html { font-family: 'Inter', sans-serif; }
        /* Dark background for the body */
        body { background-color: #1a1a1a; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        /* Custom styling for the card to match the user's image aesthetic */
        .login-card {
            /* Black bag look with subtle blur and border */
            background-color: rgba(30, 30, 30, 0.9); 
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            padding: 2.5rem;
        }
    </style>
</head>
<body>

    <!-- This div loads the GIS library and tells it which function to call -->
    <div id="g_id_onload"
         data-client_id="YOUR_GOOGLE_CLOUD_CLIENT_ID_HERE" 
         data-callback="handleCredentialResponse"
         data-auto_prompt="false"
         data-context="use">
    </div>

    <div class="login-card text-white rounded-xl">
        <!-- Title matching the image style -->
        <h1 class="text-3xl font-extrabold mb-8 text-left">Access Kaneland Site</h1>

        <!-- Instruction Text -->
        <p class="text-lg text-gray-300 mb-8">Sign in with Google to continue</p>

        <!-- Message Box for status and errors -->
        <div id="message-box" class="p-3 mb-4 rounded-lg bg-blue-600 text-sm font-medium hidden"></div>

        <!-- Placeholder for the Google Sign-In button -->
        <div id="buttonDiv" class="w-full"></div>
    </div>

    <script>
        // Use the same CLIENT_ID here as set in your environment variables for server.js
        // The one in the 'g_id_onload' data-client_id attribute must also be updated.
        const CLIENT_ID = "YOUR_GOOGLE_CLOUD_CLIENT_ID_HERE"; 
        const SERVER_ENDPOINT = "/verify-token"; 

        document.addEventListener('DOMContentLoaded', function() {
            const buttonDiv = document.getElementById('buttonDiv');

            // Render the custom-styled Google Sign-In button
            if (typeof google !== 'undefined') {
                google.accounts.id.renderButton(
                    buttonDiv,
                    {
                        theme: "filled_black",
                        size: "large",
                        type: "standard",
                        shape: "rectangular",
                        width: "100%", // Make the button full width
                        logo_alignment: "left"
                    }
                );
            } else {
                // Fallback message if GIS library fails to load
                buttonDiv.innerHTML = '<p class="text-red-400">Error: Google Sign-In library failed to load.</p>';
            }
        });

        // Function called by the Google Identity Services SDK upon successful sign-in
        async function handleCredentialResponse(response) {
            const messageBox = document.getElementById('message-box');
            messageBox.style.display = 'block';
            messageBox.className = 'p-3 mb-4 rounded-lg bg-blue-600 text-sm font-medium';
            messageBox.innerHTML = 'Verifying credentials... Please wait.';

            try {
                // Send the ID Token to the server for verification
                const serverResponse = await fetch(SERVER_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ idToken: response.credential }),
                });

                const data = await serverResponse.json();

                if (data.success) {
                    // Access GRANTED
                    messageBox.className = 'p-3 mb-4 rounded-lg bg-green-600 text-sm font-medium';
                    messageBox.innerHTML = 'Access granted! Redirecting...';
                    
                    // Delay slightly to allow the message to be seen before redirect
                    setTimeout(() => {
                        window.location.href = data.redirectUrl;
                    }, 500);

                } else {
                    // Access DENIED (or token failed verification)
                    messageBox.className = 'p-3 mb-4 rounded-lg bg-red-600 text-sm font-medium';
                    messageBox.innerHTML = data.message;
                }

            } catch (error) {
                console.error('Network or server error during verification:', error);
                messageBox.className = 'p-3 mb-4 rounded-lg bg-red-600 text-sm font-medium';
                messageBox.innerHTML = 'An unexpected error occurred. Please try again.';
            }
        }

        // Expose the function globally as required by the GIS SDK
        window.handleCredentialResponse = handleCredentialResponse;

    </script>
</body>
</html>
